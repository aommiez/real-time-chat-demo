!function(){"use strict";var MRG={VERSION:"1.1.1",BAYEUX_VERSION:"1.0",ID_LENGTH:160,JSONP_CALLBACK:"jsonpcallback",CONNECTION_TYPES:["long-polling","cross-origin-long-polling","callback-polling","websocket","eventsource","in-process"],MANDATORY_CONNECTION_TYPES:["long-polling","callback-polling","in-process"],ENV:"undefined"!=typeof window?window:global,extend:function(t,e,n){if(!e)return t;for(var i in e)e.hasOwnProperty(i)&&(t.hasOwnProperty(i)&&n===!1||t[i]!==e[i]&&(t[i]=e[i]));return t},random:function(t){t=t||this.ID_LENGTH;for(var e=Math.ceil(t*Math.log(2)/Math.log(36)),n=csprng(t,36);n.length<e;)n="0"+n;return n},validateOptions:function(t,e){for(var n in t)if(this.indexOf(e,n)<0)throw new Error("Unrecognized option: "+n)},clientIdFromMessages:function(t){var e=this.filter([].concat(t),function(t){return"/meta/connect"===t.channel});return e[0]&&e[0].clientId},copyObject:function(t){var e,n,i;if(t instanceof Array){for(e=[],n=t.length;n--;)e[n]=MRG.copyObject(t[n]);return e}if("object"==typeof t){e=null===t?null:{};for(i in t)e[i]=MRG.copyObject(t[i]);return e}return t},commonElement:function(t,e){for(var n=0,i=t.length;i>n;n++)if(-1!==this.indexOf(e,t[n]))return t[n];return null},indexOf:function(t,e){if(t.indexOf)return t.indexOf(e);for(var n=0,i=t.length;i>n;n++)if(t[n]===e)return n;return-1},map:function(t,e,n){if(t.map)return t.map(e,n);var i=[];if(t instanceof Array)for(var s=0,r=t.length;r>s;s++)i.push(e.call(n||null,t[s],s));else for(var o in t)t.hasOwnProperty(o)&&i.push(e.call(n||null,o,t[o]));return i},filter:function(t,e,n){if(t.filter)return t.filter(e,n);for(var i=[],s=0,r=t.length;r>s;s++)e.call(n||null,t[s],s)&&i.push(t[s]);return i},asyncEach:function(t,e,n,i){var s=t.length,r=-1,o=0,a=!1,c=function(){return o-=1,r+=1,r===s?n&&n.call(i):void e(t[r],u)},h=function(){if(!a){for(a=!0;o>0;)c();a=!1}},u=function(){o+=1,h()};u()},toJSON:function(t){return this.stringify?this.stringify(t,function(t,e){return this[t]instanceof Array?this[t]:e}):JSON.stringify(t)}};"undefined"!=typeof module?module.exports=MRG:"undefined"!=typeof window&&(window.MRG=MRG),MRG.Class=function(t,e){"function"!=typeof t&&(e=t,t=Object);var n=function(){return this.initialize?this.initialize.apply(this,arguments)||this:this},i=function(){};return i.prototype=t.prototype,n.prototype=new i,MRG.extend(n.prototype,e),n},function(){function t(t,e){if(t.indexOf)return t.indexOf(e);for(var n=0;n<t.length;n++)if(e===t[n])return n;return-1}var e=MRG.EventEmitter=function(){},n="function"==typeof Array.isArray?Array.isArray:function(t){return"[object Array]"===Object.prototype.toString.call(t)};e.prototype.emit=function(t){if("error"===t&&(!this._events||!this._events.error||n(this._events.error)&&!this._events.error.length))throw arguments[1]instanceof Error?arguments[1]:new Error("Uncaught, unspecified 'error' event.");if(!this._events)return!1;var e=this._events[t];if(!e)return!1;if("function"==typeof e){switch(arguments.length){case 1:e.call(this);break;case 2:e.call(this,arguments[1]);break;case 3:e.call(this,arguments[1],arguments[2]);break;default:var i=Array.prototype.slice.call(arguments,1);e.apply(this,i)}return!0}if(n(e)){for(var i=Array.prototype.slice.call(arguments,1),s=e.slice(),r=0,o=s.length;o>r;r++)s[r].apply(this,i);return!0}return!1},e.prototype.addListener=function(t,e){if("function"!=typeof e)throw new Error("addListener only takes instances of Function");return this._events||(this._events={}),this.emit("newListener",t,e),this._events[t]?n(this._events[t])?this._events[t].push(e):this._events[t]=[this._events[t],e]:this._events[t]=e,this},e.prototype.on=e.prototype.addListener,e.prototype.once=function(t,e){var n=this;return n.on(t,function i(){n.removeListener(t,i),e.apply(this,arguments)}),this},e.prototype.removeListener=function(e,i){if("function"!=typeof i)throw new Error("removeListener only takes instances of Function");if(!this._events||!this._events[e])return this;var s=this._events[e];if(n(s)){var r=t(s,i);if(0>r)return this;s.splice(r,1),0==s.length&&delete this._events[e]}else this._events[e]===i&&delete this._events[e];return this},e.prototype.removeAllListeners=function(t){return 0===arguments.length?(this._events={},this):(t&&this._events&&this._events[t]&&(this._events[t]=null),this)},e.prototype.listeners=function(t){return this._events||(this._events={}),this._events[t]||(this._events[t]=[]),n(this._events[t])||(this._events[t]=[this._events[t]]),this._events[t]}}(),MRG.Namespace=MRG.Class({initialize:function(){this._used={}},exists:function(t){return this._used.hasOwnProperty(t)},generate:function(){for(var t=MRG.random();this._used.hasOwnProperty(t);)t=MRG.random();return this._used[t]=t},release:function(t){delete this._used[t]}}),function(){var t,e=setTimeout;t="function"==typeof setImmediate?function(t){setImmediate(t)}:"object"==typeof process&&process.nextTick?function(t){process.nextTick(t)}:function(t){e(t,0)};var n=0,i=1,s=2,r=function(t){return t},o=function(t){throw t},a=function(t){if(this._state=n,this._onFulfilled=[],this._onRejected=[],"function"==typeof t){var e=this;t(function(t){f(e,t)},function(t){d(e,t)})}};a.prototype.then=function(t,e){var n=new a;return c(this,t,n),h(this,e,n),n};var c=function(t,e,s){"function"!=typeof e&&(e=r);var o=function(t){u(e,t,s)};t._state===n?t._onFulfilled.push(o):t._state===i&&o(t._value)},h=function(t,e,i){"function"!=typeof e&&(e=o);var r=function(t){u(e,t,i)};t._state===n?t._onRejected.push(r):t._state===s&&r(t._reason)},u=function(e,n,i){t(function(){l(e,n,i)})},l=function(t,e,n){var i;try{i=t(e)}catch(s){return d(n,s)}i===n?d(n,new TypeError("Recursive promise chain detected")):f(n,i)},f=a.fulfill=a.resolve=function(t,e){var n,i,s=!1;try{if(n=typeof e,i=null!==e&&("function"===n||"object"===n)&&e.then,"function"!=typeof i)return p(t,e);i.call(e,function(e){s^(s=!0)&&f(t,e)},function(e){s^(s=!0)&&d(t,e)})}catch(r){if(!(s^(s=!0)))return;d(t,r)}},p=function(t,e){if(t._state===n){t._state=i,t._value=e,t._onRejected=[];for(var s,r=t._onFulfilled;s=r.shift();)s(e)}},d=a.reject=function(t,e){if(t._state===n){t._state=s,t._reason=e,t._onFulfilled=[];for(var i,r=t._onRejected;i=r.shift();)i(e)}};a.all=function(t){return new a(function(e,n){var i,s=[],r=t.length;if(0===r)return e(s);for(i=0;r>i;i++)(function(t,i){a.fulfilled(t).then(function(t){s[i]=t,0===--r&&e(s)},n)})(t[i],i)})},a.defer=t,a.deferred=a.pending=function(){var t={};return t.promise=new a(function(e,n){t.fulfill=t.resolve=e,t.reject=n}),t},a.fulfilled=a.resolved=function(t){return new a(function(e,n){e(t)})},a.rejected=function(t){return new a(function(e,n){n(t)})},"undefined"==typeof MRG?module.exports=a:MRG.Promise=a}(),MRG.Set=MRG.Class({initialize:function(){this._index={}},add:function(t){var e=void 0!==t.id?t.id:t;return this._index.hasOwnProperty(e)?!1:(this._index[e]=t,!0)},forEach:function(t,e){for(var n in this._index)this._index.hasOwnProperty(n)&&t.call(e,this._index[n])},isEmpty:function(){for(var t in this._index)if(this._index.hasOwnProperty(t))return!1;return!0},member:function(t){for(var e in this._index)if(this._index[e]===t)return!0;return!1},remove:function(t){var e=void 0!==t.id?t.id:t,n=this._index[e];return delete this._index[e],n},toArray:function(){var t=[];return this.forEach(function(e){t.push(e)}),t}}),MRG.URI={isURI:function(t){return t&&t.protocol&&t.host&&t.path},isSameOrigin:function(t){var e=MRG.ENV.location;return t.protocol===e.protocol&&t.hostname===e.hostname&&t.port===e.port},parse:function(t){if("string"!=typeof t)return t;var e,n,i,s,r,o,a={},c=function(e,n){t=t.replace(n,function(t){return a[e]=t,""}),a[e]=a[e]||""};for(c("protocol",/^[a-z]+\:/i),c("host",/^\/\/[^\/\?#]+/),/^\//.test(t)||a.host||(t=MRG.ENV.location.pathname.replace(/[^\/]*$/,"")+t),c("pathname",/^[^\?#]*/),c("search",/^\?[^#]*/),c("hash",/^#.*/),a.protocol=a.protocol||MRG.ENV.location.protocol,a.host?(a.host=a.host.substr(2),e=a.host.split(":"),a.hostname=e[0],a.port=e[1]||""):(a.host=MRG.ENV.location.host,a.hostname=MRG.ENV.location.hostname,a.port=MRG.ENV.location.port),a.pathname=a.pathname||"/",a.path=a.pathname+a.search,n=a.search.replace(/^\?/,""),i=n?n.split("&"):[],o={},s=0,r=i.length;r>s;s++)e=i[s].split("="),o[decodeURIComponent(e[0]||"")]=decodeURIComponent(e[1]||"");return a.query=o,a.href=this.stringify(a),a},stringify:function(t){var e=t.protocol+"//"+t.hostname;return t.port&&(e+=":"+t.port),e+=t.pathname+this.queryString(t.query)+(t.hash||"")},queryString:function(t){var e=[];for(var n in t)t.hasOwnProperty(n)&&e.push(encodeURIComponent(n)+"="+encodeURIComponent(t[n]));return 0===e.length?"":"?"+e.join("&")}},MRG.Error=MRG.Class({initialize:function(t,e,n){this.code=t,this.params=Array.prototype.slice.call(e),this.message=n},toString:function(){return this.code+":"+this.params.join(",")+":"+this.message}}),MRG.Error.parse=function(t){if(t=t||"",!MRG.Grammar.ERROR.test(t))return new this(null,[],t);var e=t.split(":"),n=parseInt(e[0]),i=e[1].split(","),t=e[2];return new this(n,i,t)},MRG.Error.versionMismatch=function(){return new this(300,arguments,"Version mismatch").toString()},MRG.Error.conntypeMismatch=function(){return new this(301,arguments,"Connection types not supported").toString()},MRG.Error.extMismatch=function(){return new this(302,arguments,"Extension mismatch").toString()},MRG.Error.badRequest=function(){return new this(400,arguments,"Bad request").toString()},MRG.Error.clientUnknown=function(){return new this(401,arguments,"Unknown client").toString()},MRG.Error.parameterMissing=function(){return new this(402,arguments,"Missing required parameter").toString()},MRG.Error.channelForbidden=function(){return new this(403,arguments,"Forbidden channel").toString()},MRG.Error.channelUnknown=function(){return new this(404,arguments,"Unknown channel").toString()},MRG.Error.channelInvalid=function(){return new this(405,arguments,"Invalid channel").toString()},MRG.Error.extUnknown=function(){return new this(406,arguments,"Unknown extension").toString()},MRG.Error.publishFailed=function(){return new this(407,arguments,"Failed to publish").toString()},MRG.Error.serverError=function(){return new this(500,arguments,"Internal server error").toString()},MRG.Deferrable={then:function(t,e){var n=this;return this._promise||(this._promise=new MRG.Promise(function(t,e){n._fulfill=t,n._reject=e})),0===arguments.length?this._promise:this._promise.then(t,e)},callback:function(t,e){return this.then(function(n){t.call(e,n)})},errback:function(t,e){return this.then(null,function(n){t.call(e,n)})},timeout:function(t,e){this.then();var n=this;this._timer=MRG.ENV.setTimeout(function(){n._reject(e)},1e3*t)},setDeferredStatus:function(t,e){this._timer&&MRG.ENV.clearTimeout(this._timer),this.then(),"succeeded"===t?this._fulfill(e):"failed"===t?this._reject(e):delete this._promise}},MRG.Publisher={countListeners:function(t){return this.listeners(t).length},bind:function(t,e,n){var i=Array.prototype.slice,s=function(){e.apply(n,i.call(arguments))};return this._listeners=this._listeners||[],this._listeners.push([t,e,n,s]),this.on(t,s)},unbind:function(t,e,n){this._listeners=this._listeners||[];for(var i,s=this._listeners.length;s--;)i=this._listeners[s],i[0]===t&&(!e||i[1]===e&&i[2]===n)&&(this._listeners.splice(s,1),this.removeListener(t,i[3]))}},MRG.extend(MRG.Publisher,MRG.EventEmitter.prototype),MRG.Publisher.trigger=MRG.Publisher.emit,MRG.Timeouts={addTimeout:function(t,e,n,i){if(this._timeouts=this._timeouts||{},!this._timeouts.hasOwnProperty(t)){var s=this;this._timeouts[t]=MRG.ENV.setTimeout(function(){delete s._timeouts[t],n.call(i)},1e3*e)}},removeTimeout:function(t){this._timeouts=this._timeouts||{};var e=this._timeouts[t];e&&(MRG.ENV.clearTimeout(e),delete this._timeouts[t])},removeAllTimeouts:function(){this._timeouts=this._timeouts||{};for(var t in this._timeouts)this.removeTimeout(t)}},MRG.Logging={LOG_LEVELS:{fatal:4,error:3,warn:2,info:1,debug:0},writeLog:function(t,e){if(MRG.logger){var n=Array.prototype.slice.apply(t),i="[MRG",s=this.className,r=n.shift().replace(/\?/g,function(){try{return MRG.toJSON(n.shift())}catch(t){return"[Object]"}});for(var o in MRG)s||"function"==typeof MRG[o]&&this instanceof MRG[o]&&(s=o);s&&(i+="."+s),i+="] ","function"==typeof MRG.logger[e]?MRG.logger[e](i+r):"function"==typeof MRG.logger&&MRG.logger(i+r)}}},function(){for(var t in MRG.Logging.LOG_LEVELS)(function(t){MRG.Logging[t]=function(){this.writeLog(arguments,t)}})(t)}(),MRG.Grammar={CHANNEL_NAME:/^\/(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)))+(\/(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)))+)*$/,CHANNEL_PATTERN:/^(\/(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)))+)*\/\*{1,2}$/,ERROR:/^([0-9][0-9][0-9]:(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*(,(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*)*:(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*|[0-9][0-9][0-9]::(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*)$/,VERSION:/^([0-9])+(\.(([a-z]|[A-Z])|[0-9])(((([a-z]|[A-Z])|[0-9])|\-|\_))*)*$/},MRG.Extensible={addExtension:function(t){this._extensions=this._extensions||[],this._extensions.push(t),t.added&&t.added(this)},removeExtension:function(t){if(this._extensions)for(var e=this._extensions.length;e--;)this._extensions[e]===t&&(this._extensions.splice(e,1),t.removed&&t.removed(this))},pipeThroughExtensions:function(t,e,n,i,s){if(this.debug("Passing through ? extensions: ?",t,e),!this._extensions)return i.call(s,e);var r=this._extensions.slice(),o=function(e){if(!e)return i.call(s,e);var a=r.shift();if(!a)return i.call(s,e);var c=a[t];return c?void(c.length>=3?a[t](e,n,o):a[t](e,o)):o(e)};o(e)}},MRG.extend(MRG.Extensible,MRG.Logging),MRG.Channel=MRG.Class({initialize:function(t){this.id=this.name=t},push:function(t){this.trigger("message",t)},isUnused:function(){return 0===this.countListeners("message")}}),MRG.extend(MRG.Channel.prototype,MRG.Publisher),MRG.extend(MRG.Channel,{HANDSHAKE:"/meta/handshake",CONNECT:"/meta/connect",SUBSCRIBE:"/meta/subscribe",UNSUBSCRIBE:"/meta/unsubscribe",DISCONNECT:"/meta/disconnect",META:"meta",SERVICE:"service",expand:function(t){var e=this.parse(t),n=["/**",t],i=e.slice();i[i.length-1]="*",n.push(this.unparse(i));for(var s=1,r=e.length;r>s;s++)i=e.slice(0,s),i.push("**"),n.push(this.unparse(i));return n},isValid:function(t){return MRG.Grammar.CHANNEL_NAME.test(t)||MRG.Grammar.CHANNEL_PATTERN.test(t)},parse:function(t){return this.isValid(t)?t.split("/").slice(1):null},unparse:function(t){return"/"+t.join("/")},isMeta:function(t){var e=this.parse(t);return e?e[0]===this.META:null},isService:function(t){var e=this.parse(t);return e?e[0]===this.SERVICE:null},isSubscribable:function(t){return this.isValid(t)?!this.isMeta(t)&&!this.isService(t):null},Set:MRG.Class({initialize:function(){this._channels={}},getKeys:function(){var t=[];for(var e in this._channels)t.push(e);return t},remove:function(t){delete this._channels[t]},hasSubscription:function(t){return this._channels.hasOwnProperty(t)},subscribe:function(t,e,n){for(var i,s=0,r=t.length;r>s;s++){i=t[s];var o=this._channels[i]=this._channels[i]||new MRG.Channel(i);e&&o.bind("message",e,n)}},unsubscribe:function(t,e,n){var i=this._channels[t];return i?(i.unbind("message",e,n),i.isUnused()?(this.remove(t),!0):!1):!1},distributeMessage:function(t){for(var e=MRG.Channel.expand(t.channel),n=0,i=e.length;i>n;n++){var s=this._channels[e[n]];s&&s.trigger("message",t.data)}}})}),MRG.Publication=MRG.Class(MRG.Deferrable),MRG.Subscription=MRG.Class({initialize:function(t,e,n,i){this._client=t,this._channels=e,this._callback=n,this._context=i,this._cancelled=!1},cancel:function(){this._cancelled||(this._client.unsubscribe(this._channels,this._callback,this._context),this._cancelled=!0)},unsubscribe:function(){this.cancel()}}),MRG.extend(MRG.Subscription.prototype,MRG.Deferrable),MRG.Client=MRG.Class({UNCONNECTED:1,CONNECTING:2,CONNECTED:3,DISCONNECTED:4,HANDSHAKE:"handshake",RETRY:"retry",NONE:"none",CONNECTION_TIMEOUT:60,DEFAULT_ENDPOINT:"http://apibox.me:3456/mrg",INTERVAL:0,initialize:function(t,e){this.info("New client created for ?",t),e=e||{},MRG.validateOptions(e,["interval","timeout","endpoints","proxy","retry","scheduler","websocketExtensions","tls","ca"]),this._endpoint=t||this.DEFAULT_ENDPOINT,this._channels=new MRG.Channel.Set,this._dispatcher=new MRG.Dispatcher(this,this._endpoint,e),this._messageId=0,this._state=this.UNCONNECTED,this._responseCallbacks={},this._advice={reconnect:this.RETRY,interval:1e3*(e.interval||this.INTERVAL),timeout:1e3*(e.timeout||this.CONNECTION_TIMEOUT)},this._dispatcher.timeout=this._advice.timeout/1e3,this._dispatcher.bind("message",this._receiveMessage,this),MRG.Event&&void 0!==MRG.ENV.onbeforeunload&&MRG.Event.on(MRG.ENV,"beforeunload",function(){MRG.indexOf(this._dispatcher._disabled,"autodisconnect")<0&&this.disconnect()},this)},addWebsocketExtension:function(t){return this._dispatcher.addWebsocketExtension(t)},disable:function(t){return this._dispatcher.disable(t)},setHeader:function(t,e){return this._dispatcher.setHeader(t,e)},handshake:function(t,e){if(this._advice.reconnect!==this.NONE&&this._state===this.UNCONNECTED){this._state=this.CONNECTING;var n=this;this.info("Initiating handshake with ?",MRG.URI.stringify(this._endpoint)),this._dispatcher.selectTransport(MRG.MANDATORY_CONNECTION_TYPES),this._sendMessage({channel:MRG.Channel.HANDSHAKE,version:MRG.BAYEUX_VERSION,supportedConnectionTypes:this._dispatcher.getConnectionTypes()},{},function(i){i.successful?(this._state=this.CONNECTED,this._dispatcher.clientId=i.clientId,this._dispatcher.selectTransport(i.supportedConnectionTypes),this.info("Handshake successful: ?",this._dispatcher.clientId),this.subscribe(this._channels.getKeys(),!0),t&&MRG.Promise.defer(function(){t.call(e)})):(this.info("Handshake unsuccessful"),MRG.ENV.setTimeout(function(){n.handshake(t,e)},1e3*this._dispatcher.retry),this._state=this.UNCONNECTED)},this)}},connect:function(t,e){if(this._advice.reconnect!==this.NONE&&this._state!==this.DISCONNECTED){if(this._state===this.UNCONNECTED)return this.handshake(function(){this.connect(t,e)},this);this.callback(t,e),this._state===this.CONNECTED&&(this.info("Calling deferred actions for ?",this._dispatcher.clientId),this.setDeferredStatus("succeeded"),this.setDeferredStatus("unknown"),this._connectRequest||(this._connectRequest=!0,this.info("Initiating connection for ?",this._dispatcher.clientId),this._sendMessage({channel:MRG.Channel.CONNECT,clientId:this._dispatcher.clientId,connectionType:this._dispatcher.connectionType},{},this._cycleConnection,this)))}},disconnect:function(){if(this._state===this.CONNECTED){this._state=this.DISCONNECTED,this.info("Disconnecting ?",this._dispatcher.clientId);var t=new MRG.Publication;return this._sendMessage({channel:MRG.Channel.DISCONNECT,clientId:this._dispatcher.clientId},{},function(e){e.successful?(this._dispatcher.close(),t.setDeferredStatus("succeeded")):t.setDeferredStatus("failed",MRG.Error.parse(e.error))},this),this.info("Clearing channel listeners for ?",this._dispatcher.clientId),this._channels=new MRG.Channel.Set,t}},subscribe:function(t,e,n){if(t instanceof Array)return MRG.map(t,function(t){return this.subscribe(t,e,n)},this);var i=new MRG.Subscription(this,t,e,n),s=e===!0,r=this._channels.hasSubscription(t);return r&&!s?(this._channels.subscribe([t],e,n),i.setDeferredStatus("succeeded"),i):(this.connect(function(){this.info("Client ? attempting to subscribe to ?",this._dispatcher.clientId,t),s||this._channels.subscribe([t],e,n),this._sendMessage({channel:MRG.Channel.SUBSCRIBE,clientId:this._dispatcher.clientId,subscription:t},{},function(s){if(!s.successful)return i.setDeferredStatus("failed",MRG.Error.parse(s.error)),this._channels.unsubscribe(t,e,n);var r=[].concat(s.subscription);this.info("Subscription acknowledged for ? to ?",this._dispatcher.clientId,r),i.setDeferredStatus("succeeded")},this)},this),i)},unsubscribe:function(t,e,n){if(t instanceof Array)return MRG.map(t,function(t){return this.unsubscribe(t,e,n)},this);var i=this._channels.unsubscribe(t,e,n);i&&this.connect(function(){this.info("Client ? attempting to unsubscribe from ?",this._dispatcher.clientId,t),this._sendMessage({channel:MRG.Channel.UNSUBSCRIBE,clientId:this._dispatcher.clientId,subscription:t},{},function(t){if(t.successful){var e=[].concat(t.subscription);this.info("Unsubscription acknowledged for ? from ?",this._dispatcher.clientId,e)}},this)},this)},publish:function(t,e,n){MRG.validateOptions(n||{},["attempts","deadline"]);var i=new MRG.Publication;return this.connect(function(){this.info("Client ? queueing published message to ?: ?",this._dispatcher.clientId,t,e),this._sendMessage({channel:t,data:e,clientId:this._dispatcher.clientId},n,function(t){t.successful?i.setDeferredStatus("succeeded"):i.setDeferredStatus("failed",MRG.Error.parse(t.error))},this)},this),i},_sendMessage:function(t,e,n,i){t.id=this._generateMessageId();var s=this._advice.timeout?1.2*this._advice.timeout/1e3:1.2*this._dispatcher.retry;this.pipeThroughExtensions("outgoing",t,null,function(t){t&&(n&&(this._responseCallbacks[t.id]=[n,i]),this._dispatcher.sendMessage(t,s,e||{}))},this)},_generateMessageId:function(){return this._messageId+=1,this._messageId>=Math.pow(2,32)&&(this._messageId=0),this._messageId.toString(36)},_receiveMessage:function(t){var e,n=t.id;void 0!==t.successful&&(e=this._responseCallbacks[n],delete this._responseCallbacks[n]),this.pipeThroughExtensions("incoming",t,null,function(t){t&&(t.advice&&this._handleAdvice(t.advice),this._deliverMessage(t),e&&e[0].call(e[1],t))},this)},_handleAdvice:function(t){MRG.extend(this._advice,t),this._dispatcher.timeout=this._advice.timeout/1e3,this._advice.reconnect===this.HANDSHAKE&&this._state!==this.DISCONNECTED&&(this._state=this.UNCONNECTED,this._dispatcher.clientId=null,this._cycleConnection())},_deliverMessage:function(t){t.channel&&void 0!==t.data&&(this.info("Client ? calling listeners for ? with ?",this._dispatcher.clientId,t.channel,t.data),this._channels.distributeMessage(t))},_cycleConnection:function(){this._connectRequest&&(this._connectRequest=null,this.info("Closed connection for ?",this._dispatcher.clientId));var t=this;MRG.ENV.setTimeout(function(){t.connect()},this._advice.interval)}}),MRG.extend(MRG.Client.prototype,MRG.Deferrable),MRG.extend(MRG.Client.prototype,MRG.Publisher),MRG.extend(MRG.Client.prototype,MRG.Logging),MRG.extend(MRG.Client.prototype,MRG.Extensible),MRG.Dispatcher=MRG.Class({MAX_REQUEST_SIZE:2048,DEFAULT_RETRY:5,UP:1,DOWN:2,initialize:function(t,e,n){this._client=t,this.endpoint=MRG.URI.parse(e),this._alternates=n.endpoints||{},this.cookies=MRG.Cookies&&new MRG.Cookies.CookieJar,this._disabled=[],this._envelopes={},this.headers={},this.retry=n.retry||this.DEFAULT_RETRY,this._scheduler=n.scheduler||MRG.Scheduler,this._state=0,this.transports={},this.wsExtensions=[],this.proxy=n.proxy||{},"string"==typeof this._proxy&&(this._proxy={origin:this._proxy});var i=n.websocketExtensions;if(i){i=[].concat(i);for(var s=0,r=i.length;r>s;s++)this.addWebsocketExtension(i[s])}this.tls=n.tls||{},this.tls.ca=this.tls.ca||n.ca;for(var o in this._alternates)this._alternates[o]=MRG.URI.parse(this._alternates[o]);this.maxRequestSize=this.MAX_REQUEST_SIZE},endpointFor:function(t){return this._alternates[t]||this.endpoint},addWebsocketExtension:function(t){this.wsExtensions.push(t)},disable:function(t){this._disabled.push(t)},setHeader:function(t,e){this.headers[t]=e},close:function(){var t=this._transport;delete this._transport,t&&t.close()},getConnectionTypes:function(){return MRG.Transport.getConnectionTypes()},selectTransport:function(t){MRG.Transport.get(this,t,this._disabled,function(t){this.debug("Selected ? transport for ?",t.connectionType,MRG.URI.stringify(t.endpoint)),t!==this._transport&&(this._transport&&this._transport.close(),this._transport=t,this.connectionType=t.connectionType)},this)},sendMessage:function(t,e,n){n=n||{};var i,s=t.id,r=n.attempts,o=n.deadline&&(new Date).getTime()+1e3*n.deadline,a=this._envelopes[s];a||(i=new this._scheduler(t,{timeout:e,interval:this.retry,attempts:r,deadline:o}),a=this._envelopes[s]={message:t,scheduler:i}),this._sendEnvelope(a)},_sendEnvelope:function(t){if(this._transport&&!t.request&&!t.timer){var e=t.message,n=t.scheduler,i=this;if(!n.isDeliverable())return n.abort(),void delete this._envelopes[e.id];t.timer=MRG.ENV.setTimeout(function(){i.handleError(e)},1e3*n.getTimeout()),n.send(),t.request=this._transport.sendMessage(e)}},handleResponse:function(t){var e=this._envelopes[t.id];void 0!==t.successful&&e&&(e.scheduler.succeed(),delete this._envelopes[t.id],MRG.ENV.clearTimeout(e.timer)),this.trigger("message",t),this._state!==this.UP&&(this._state=this.UP,this._client.trigger("transport:up"))},handleError:function(t,e){var n=this._envelopes[t.id],i=n&&n.request,s=this;if(i){i.then(function(t){t&&t.abort&&t.abort()});var r=n.scheduler;r.fail(),MRG.ENV.clearTimeout(n.timer),n.request=n.timer=null,e?this._sendEnvelope(n):n.timer=MRG.ENV.setTimeout(function(){n.timer=null,s._sendEnvelope(n)},1e3*r.getInterval()),this._state!==this.DOWN&&(this._state=this.DOWN,this._client.trigger("transport:down"))}}}),MRG.extend(MRG.Dispatcher.prototype,MRG.Publisher),MRG.extend(MRG.Dispatcher.prototype,MRG.Logging),MRG.Scheduler=function(t,e){this.message=t,this.options=e,this.attempts=0},MRG.extend(MRG.Scheduler.prototype,{getTimeout:function(){return this.options.timeout},getInterval:function(){return this.options.interval},isDeliverable:function(){var t=this.options.attempts,e=this.attempts,n=this.options.deadline,i=(new Date).getTime();return void 0!==t&&e>=t?!1:void 0!==n&&i>n?!1:!0},send:function(){this.attempts+=1},succeed:function(){},fail:function(){},abort:function(){}}),MRG.Transport=MRG.extend(MRG.Class({DEFAULT_PORTS:{"http:":80,"https:":443,"ws:":80,"wss:":443},SECURE_PROTOCOLS:["https:","wss:"],MAX_DELAY:0,batching:!0,initialize:function(t,e){this._dispatcher=t,this.endpoint=e,this._outbox=[],this._proxy=MRG.extend({},this._dispatcher.proxy),!this._proxy.origin&&MRG.NodeAdapter&&(this._proxy.origin=MRG.indexOf(this.SECURE_PROTOCOLS,this.endpoint.protocol)>=0?process.env.HTTPS_PROXY||process.env.https_proxy:process.env.HTTP_PROXY||process.env.http_proxy)},close:function(){},encode:function(t){return""},sendMessage:function(t){return this.debug("Client ? sending message to ?: ?",this._dispatcher.clientId,MRG.URI.stringify(this.endpoint),t),this.batching?(this._outbox.push(t),this._flushLargeBatch(),this._promise=this._promise||new MRG.Promise,t.channel===MRG.Channel.HANDSHAKE?(this.addTimeout("publish",.01,this._flush,this),this._promise):(t.channel===MRG.Channel.CONNECT&&(this._connectMessage=t),this.addTimeout("publish",this.MAX_DELAY,this._flush,this),this._promise)):MRG.Promise.fulfilled(this.request([t]))},_flush:function(){this.removeTimeout("publish"),this._outbox.length>1&&this._connectMessage&&(this._connectMessage.advice={timeout:0}),MRG.Promise.fulfill(this._promise,this.request(this._outbox)),delete this._promise,this._connectMessage=null,this._outbox=[]},_flushLargeBatch:function(){var t=this.encode(this._outbox);if(!(t.length<this._dispatcher.maxRequestSize)){var e=this._outbox.pop();this._flush(),e&&this._outbox.push(e)}},_receive:function(t){if(t){t=[].concat(t),this.debug("Client ? received from ? via ?: ?",this._dispatcher.clientId,MRG.URI.stringify(this.endpoint),this.connectionType,t);for(var e=0,n=t.length;n>e;e++)this._dispatcher.handleResponse(t[e])}},_handleError:function(t,e){t=[].concat(t),this.debug("Client ? failed to send to ? via ?: ?",this._dispatcher.clientId,MRG.URI.stringify(this.endpoint),this.connectionType,t);for(var n=0,i=t.length;i>n;n++)this._dispatcher.handleError(t[n])},_getCookies:function(){var t=this._dispatcher.cookies,e=MRG.URI.stringify(this.endpoint);return t?MRG.map(t.getCookiesSync(e),function(t){return t.cookieString()}).join("; "):""},_storeCookies:function(t){var e,n=this._dispatcher.cookies,i=MRG.URI.stringify(this.endpoint);if(t&&n){t=[].concat(t);for(var s=0,r=t.length;r>s;s++)e=MRG.Cookies.Cookie.parse(t[s]),n.setCookieSync(e,i)}}}),{get:function(t,e,n,i,s){var r=t.endpoint;MRG.asyncEach(this._transports,function(r,o){var a=r[0],c=r[1],h=t.endpointFor(a);return MRG.indexOf(n,a)>=0?o():MRG.indexOf(e,a)<0?(c.isUsable(t,h,function(){}),o()):void c.isUsable(t,h,function(e){if(!e)return o();var n=c.hasOwnProperty("create")?c.create(t,h):new c(t,h);i.call(s,n)})},function(){throw new Error("Could not find a usable connection type for "+MRG.URI.stringify(r))})},register:function(t,e){this._transports.push([t,e]),e.prototype.connectionType=t},getConnectionTypes:function(){return MRG.map(this._transports,function(t){return t[0]})},_transports:[]}),MRG.extend(MRG.Transport.prototype,MRG.Logging),MRG.extend(MRG.Transport.prototype,MRG.Timeouts),MRG.Event={_registry:[],on:function(t,e,n,i){var s=function(){n.call(i)};t.addEventListener?t.addEventListener(e,s,!1):t.attachEvent("on"+e,s),this._registry.push({_element:t,_type:e,_callback:n,_context:i,_handler:s})},detach:function(t,e,n,i){for(var s,r=this._registry.length;r--;)s=this._registry[r],t&&t!==s._element||e&&e!==s._type||n&&n!==s._callback||i&&i!==s._context||(s._element.removeEventListener?s._element.removeEventListener(s._type,s._handler,!1):s._element.detachEvent("on"+s._type,s._handler),this._registry.splice(r,1),s=null)}},void 0!==MRG.ENV.onunload&&MRG.Event.on(MRG.ENV,"unload",MRG.Event.detach,MRG.Event),"object"!=typeof JSON&&(JSON={}),function(){function f(t){return 10>t?"0"+t:t}function quote(t){return escapable.lastIndex=0,escapable.test(t)?'"'+t.replace(escapable,function(t){var e=meta[t];return"string"==typeof e?e:"\\u"+("0000"+t.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+t+'"'}function str(t,e){var n,i,s,r,o,a=gap,c=e[t];switch(c&&"object"==typeof c&&"function"==typeof c.toJSON&&(c=c.toJSON(t)),"function"==typeof rep&&(c=rep.call(e,t,c)),typeof c){case"string":return quote(c);case"number":return isFinite(c)?String(c):"null";case"boolean":case"null":return String(c);case"object":if(!c)return"null";if(gap+=indent,o=[],"[object Array]"===Object.prototype.toString.apply(c)){for(r=c.length,n=0;r>n;n+=1)o[n]=str(n,c)||"null";return s=0===o.length?"[]":gap?"[\n"+gap+o.join(",\n"+gap)+"\n"+a+"]":"["+o.join(",")+"]",gap=a,s}if(rep&&"object"==typeof rep)for(r=rep.length,n=0;r>n;n+=1)"string"==typeof rep[n]&&(i=rep[n],s=str(i,c),s&&o.push(quote(i)+(gap?": ":":")+s));else for(i in c)Object.prototype.hasOwnProperty.call(c,i)&&(s=str(i,c),s&&o.push(quote(i)+(gap?": ":":")+s));return s=0===o.length?"{}":gap?"{\n"+gap+o.join(",\n"+gap)+"\n"+a+"}":"{"+o.join(",")+"}",gap=a,s}}"function"!=typeof Date.prototype.toJSON&&(Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()});var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;MRG.stringify=function(t,e,n){var i;if(gap="",indent="","number"==typeof n)for(i=0;n>i;i+=1)indent+=" ";else"string"==typeof n&&(indent=n);if(rep=e,e&&"function"!=typeof e&&("object"!=typeof e||"number"!=typeof e.length))throw new Error("JSON.stringify");return str("",{"":t})},"function"!=typeof JSON.stringify&&(JSON.stringify=MRG.stringify),"function"!=typeof JSON.parse&&(JSON.parse=function(text,reviver){function walk(t,e){var n,i,s=t[e];if(s&&"object"==typeof s)for(n in s)Object.prototype.hasOwnProperty.call(s,n)&&(i=walk(s,n),void 0!==i?s[n]=i:delete s[n]);
    return reviver.call(t,e,s)}var j;if(text=String(text),cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(t){return"\\u"+("0000"+t.charCodeAt(0).toString(16)).slice(-4)})),/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return j=eval("("+text+")"),"function"==typeof reviver?walk({"":j},""):j;throw new SyntaxError("JSON.parse")})}(),MRG.Transport.WebSocket=MRG.extend(MRG.Class(MRG.Transport,{UNCONNECTED:1,CONNECTING:2,CONNECTED:3,batching:!1,isUsable:function(t,e){this.callback(function(){t.call(e,!0)}),this.errback(function(){t.call(e,!1)}),this.connect()},request:function(t){this._pending=this._pending||new MRG.Set;for(var e=0,n=t.length;n>e;e++)this._pending.add(t[e]);var i=new MRG.Promise;return this.callback(function(e){e&&(e.send(MRG.toJSON(t)),MRG.Promise.fulfill(i,e))},this),this.connect(),{abort:function(){i.then(function(t){t.close()})}}},connect:function(){if(!MRG.Transport.WebSocket._unloaded&&(this._state=this._state||this.UNCONNECTED,this._state===this.UNCONNECTED)){this._state=this.CONNECTING;var t=this._createSocket();if(!t)return this.setDeferredStatus("failed");var e=this;t.onopen=function(){t.headers&&e._storeCookies(t.headers["set-cookie"]),e._socket=t,e._state=e.CONNECTED,e._everConnected=!0,e._ping(),e.setDeferredStatus("succeeded",t)};var n=!1;t.onclose=t.onerror=function(){if(!n){n=!0;var i=e._state===e.CONNECTED;t.onopen=t.onclose=t.onerror=t.onmessage=null,delete e._socket,e._state=e.UNCONNECTED,e.removeTimeout("ping"),e.setDeferredStatus("unknown");var s=e._pending?e._pending.toArray():[];delete e._pending,i?e._handleError(s,!0):e._everConnected?e._handleError(s):e.setDeferredStatus("failed")}},t.onmessage=function(t){var n=JSON.parse(t.data);if(n){n=[].concat(n);for(var i=0,s=n.length;s>i;i++)void 0!==n[i].successful&&e._pending.remove(n[i]);e._receive(n)}}}},close:function(){this._socket&&this._socket.close()},_createSocket:function(){var t=MRG.Transport.WebSocket.getSocketUrl(this.endpoint),e=this._dispatcher.headers,n=this._dispatcher.wsExtensions,i=this._getCookies(),s=this._dispatcher.tls,r={extensions:n,headers:e,proxy:this._proxy,tls:s};return""!==i&&(r.headers.Cookie=i),MRG.WebSocket?new MRG.WebSocket.Client(t,[],r):MRG.ENV.MozWebSocket?new MozWebSocket(t):MRG.ENV.WebSocket?new WebSocket(t):void 0},_ping:function(){this._socket&&(this._socket.send("[]"),this.addTimeout("ping",this._dispatcher.timeout/2,this._ping,this))}}),{PROTOCOLS:{"http:":"ws:","https:":"wss:"},create:function(t,e){var n=t.transports.websocket=t.transports.websocket||{};return n[e.href]=n[e.href]||new this(t,e),n[e.href]},getSocketUrl:function(t){return t=MRG.copyObject(t),t.protocol=this.PROTOCOLS[t.protocol],MRG.URI.stringify(t)},isUsable:function(t,e,n,i){this.create(t,e).isUsable(n,i)}}),MRG.extend(MRG.Transport.WebSocket.prototype,MRG.Deferrable),MRG.Transport.register("websocket",MRG.Transport.WebSocket),MRG.Event&&void 0!==MRG.ENV.onbeforeunload&&MRG.Event.on(MRG.ENV,"beforeunload",function(){MRG.Transport.WebSocket._unloaded=!0}),MRG.Transport.EventSource=MRG.extend(MRG.Class(MRG.Transport,{initialize:function(t,e){if(MRG.Transport.prototype.initialize.call(this,t,e),!MRG.ENV.EventSource)return this.setDeferredStatus("failed");this._xhr=new MRG.Transport.XHR(t,e),e=MRG.copyObject(e),e.pathname+="/"+t.clientId;var n=new EventSource(MRG.URI.stringify(e)),i=this;n.onopen=function(){i._everConnected=!0,i.setDeferredStatus("succeeded")},n.onerror=function(){i._everConnected?i._handleError([]):(i.setDeferredStatus("failed"),n.close())},n.onmessage=function(t){i._receive(JSON.parse(t.data))},this._socket=n},close:function(){this._socket&&(this._socket.onopen=this._socket.onerror=this._socket.onmessage=null,this._socket.close(),delete this._socket)},isUsable:function(t,e){this.callback(function(){t.call(e,!0)}),this.errback(function(){t.call(e,!1)})},encode:function(t){return this._xhr.encode(t)},request:function(t){return this._xhr.request(t)}}),{isUsable:function(t,e,n,i){var s=t.clientId;return s?void MRG.Transport.XHR.isUsable(t,e,function(s){return s?void this.create(t,e).isUsable(n,i):n.call(i,!1)},this):n.call(i,!1)},create:function(t,e){var n=t.transports.eventsource=t.transports.eventsource||{},i=t.clientId,s=MRG.copyObject(e);return s.pathname+="/"+(i||""),s=MRG.URI.stringify(s),n[s]=n[s]||new this(t,e),n[s]}}),MRG.extend(MRG.Transport.EventSource.prototype,MRG.Deferrable),MRG.Transport.register("eventsource",MRG.Transport.EventSource),MRG.Transport.XHR=MRG.extend(MRG.Class(MRG.Transport,{encode:function(t){return MRG.toJSON(t)},request:function(t){var e=this.endpoint.href,n=MRG.ENV.ActiveXObject?new ActiveXObject("Microsoft.XMLHTTP"):new XMLHttpRequest,i=this;n.open("POST",e,!0),n.setRequestHeader("Content-Type","application/json"),n.setRequestHeader("Pragma","no-cache"),n.setRequestHeader("X-Requested-With","XMLHttpRequest");var s=this._dispatcher.headers;for(var r in s)s.hasOwnProperty(r)&&n.setRequestHeader(r,s[r]);var o=function(){n.abort()};return void 0!==MRG.ENV.onbeforeunload&&MRG.Event.on(MRG.ENV,"beforeunload",o),n.onreadystatechange=function(){if(n&&4===n.readyState){var e=null,s=n.status,r=n.responseText,a=s>=200&&300>s||304===s||1223===s;if(void 0!==MRG.ENV.onbeforeunload&&MRG.Event.detach(MRG.ENV,"beforeunload",o),n.onreadystatechange=function(){},n=null,!a)return i._handleError(t);try{e=JSON.parse(r)}catch(c){}e?i._receive(e):i._handleError(t)}},n.send(this.encode(t)),n}}),{isUsable:function(t,e,n,i){n.call(i,MRG.URI.isSameOrigin(e))}}),MRG.Transport.register("long-polling",MRG.Transport.XHR),MRG.Transport.CORS=MRG.extend(MRG.Class(MRG.Transport,{encode:function(t){return"message="+encodeURIComponent(MRG.toJSON(t))},request:function(t){var e,n=MRG.ENV.XDomainRequest?XDomainRequest:XMLHttpRequest,i=new n,s=this._dispatcher.headers,r=this;if(i.open("POST",MRG.URI.stringify(this.endpoint),!0),i.setRequestHeader){i.setRequestHeader("Pragma","no-cache");for(e in s)s.hasOwnProperty(e)&&i.setRequestHeader(e,s[e])}var o=function(){return i?(i.onload=i.onerror=i.ontimeout=i.onprogress=null,void(i=null)):!1};return i.onload=function(){var e=null;try{e=JSON.parse(i.responseText)}catch(n){}o(),e?r._receive(e):r._handleError(t)},i.onerror=i.ontimeout=function(){o(),r._handleError(t)},i.onprogress=function(){},i.send(this.encode(t)),i}}),{isUsable:function(t,e,n,i){if(MRG.URI.isSameOrigin(e))return n.call(i,!1);if(MRG.ENV.XDomainRequest)return n.call(i,e.protocol===MRG.ENV.location.protocol);if(MRG.ENV.XMLHttpRequest){var s=new MRG.ENV.XMLHttpRequest;return n.call(i,void 0!==s.withCredentials)}return n.call(i,!1)}}),MRG.Transport.register("cross-origin-long-polling",MRG.Transport.CORS),MRG.Transport.JSONP=MRG.extend(MRG.Class(MRG.Transport,{encode:function(t){var e=MRG.copyObject(this.endpoint);return e.query.message=MRG.toJSON(t),e.query.jsonp="__jsonp"+MRG.Transport.JSONP._cbCount+"__",MRG.URI.stringify(e)},request:function(t){var e=document.getElementsByTagName("head")[0],n=document.createElement("script"),i=MRG.Transport.JSONP.getCallbackName(),s=MRG.copyObject(this.endpoint),r=this;s.query.message=MRG.toJSON(t),s.query.jsonp=i;var o=function(){if(!MRG.ENV[i])return!1;MRG.ENV[i]=void 0;try{delete MRG.ENV[i]}catch(t){}n.parentNode.removeChild(n)};return MRG.ENV[i]=function(t){o(),r._receive(t)},n.type="text/javascript",n.src=MRG.URI.stringify(s),e.appendChild(n),n.onerror=function(){o(),r._handleError(t)},{abort:o}}}),{_cbCount:0,getCallbackName:function(){return this._cbCount+=1,"__jsonp"+this._cbCount+"__"},isUsable:function(t,e,n,i){n.call(i,!0)}}),MRG.Transport.register("callback-polling",MRG.Transport.JSONP)}();